<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./assets/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="//cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.js"></script>
    <link rel="stylesheet" href="style.css" />
    <title>Donate drones or money</title>
  </head>
  <body>
    <header><p class="text">Phaser Demo | Donate drones or money</p></header>
    <main>
      <canvas id="gameCanvas"></canvas>
      <div id="gameStarDiv" class="gameUI">
        <h1>Donate drones or money</h1>
        <p>
          You have 60 seconds to catch the bitcoins but must avoid the bomb. It
          resets the number of points
        </p>
        <p>If you catch more than 30 bitcoins you win.</p>
        <p>If you catch less than 30 bitcoins, you lose and send a donation.</p>
        <p>Сlick the start button to begin</p>

        <button id="gameStartBtn">Start</button>
      </div>
      <div id="gameEndDiv" class="gameUI">
        <img
          src="./assets/banerdronmin.png"
          alt="Baner Thank you"
          width="400"
          height="220"
        />
        <p>Game over. Final Score: <span id="gameEndScoreSpan"></span></p>
        <p id="gameResult">You <span id="gameWinLoseSpan"></span></p>
        <p id="gameSpam"></p>
        <div id="link">
          <a
            target="_blank"
            href="https://savelife.in.ua/donate/#donate-army-card-monthly"
            rel="noopener noreferrer"
          >
            The Charity Foundation "Come Back Alive"
          </a>
          <br />
          <a
            target="_blank"
            href="https://t.me/donatlacheny"
            rel="noopener noreferrer"
          >
            "Donat Lacheny"
          </a>
          <br />
          <a
            target="_blank"
            href="https://t.me/tung_helps_ua"
            rel="noopener noreferrer"
            >"Tung_Helps_UA"</a
          >
        </div>
        <p>Refresh the Page to play again</p>
        <button id="gameRestartBtn">Restart</button>
      </div>
    </main>
    <footer><p class="text">Created by Yulia 2024</p></footer>

    <script>
      const speedDown = 500;
      let sizes = {
        width: "",
        height: "",
      };
      let mediaQuery = window.matchMedia("(max-width: 600px)");
      const screenWidth = window.screen.width;
      const screenHeight = window.screen.height;
      const orientation = screenWidth > screenHeight ? "landscape" : "portrait";

      function handleMatches() {
        if (window.innerWidth < 600 || orientation === "landscape") {
          sizes.width = innerWidth - 50;
          sizes.height = innerHeight - 150;
        } else {
          sizes.width = 500;
          sizes.height = 450;
        }
      }
      mediaQuery.addListener(handleMatches);
      handleMatches();
      const refs = {
        gameStartDiv: document.querySelector("#gameStarDiv"),
        gameStartBtn: document.querySelector("#gameStartBtn"),
        gameEndDiv: document.querySelector("#gameEndDiv"),
        gameWinLoseSpan: document.querySelector("#gameWinLoseSpan"),
        gameEndScoreSpan: document.querySelector("#gameEndScoreSpan"),
        gameRestartBtn: document.querySelector("#gameRestartBtn"),
        gameSpam: document.querySelector("#gameSpam"),
        link: document.querySelector("#link"),
        gameResult: document.querySelector("#gameResult"),
      };

      class GameScene extends Phaser.Scene {
        constructor() {
          super("scene-game");
          this.player;
          this.cursors;
          this.target;
          this.playerSpeed = speedDown + 50;
          this.textScore;
          this.textTime;
          this.timedEvent;
          this.remainingTime;
          this.coinMusic;
          this.bombMusic;
          this.bgMusic;
          this.emitter;
          this.bomb;
          this.points = 0;
          this.musicStarted = false;
        }

        preload() {
          // this.load.image("bgt", "assets/bgt.png");
          this.load.image("jar", "assets/jar.png");
          this.load.image("bit1", "assets/bit1.png");
          this.load.image("moneyd", "assets/moneyd.png");
          this.load.image("bomb", "assets/bomb.png");
          // this.load.audio("bgDMusic", "assets/bgDMusic.mp3");
          this.load.audio("bfDsound", "assets/bfDsound.mp3");
          this.load.audio("coin", "assets/coin.mp3");
          this.load.audio("bomb", "assets/bomb.wav");
          if (mediaQuery.matches || orientation === "landscape") {
            this.load.image("bgt", "assets/small-bg.jpg");
          } else {
            this.load.image("bgt", "assets/bgt.png");
          }
        }

        create() {
          this.scene.pause("scene-game");
          this.coinMusic = this.sound.add("coin");
          this.bombMusic = this.sound.add("bomb");
          this.bgMusic = this.sound.add("bfDsound");
          // this.bgMusic.play();
          // this.bgMusic.stop();

          this.add.image(0, 0, "bgt").setOrigin(0, 0);
          this.player = this.physics.add.image(0, sizes.height, "jar");
          this.player.setImmovable(true);
          this.player.body.allowGravity = false;
          this.player.setCollideWorldBounds(true);
          this.player
            .setSize(
              this.player.width - this.player.width / 4,
              this.player.height / 6
            )
            .setOffset(
              this.player.width / 10,
              this.player.height - this.player.height / 10
            );
          this.target = this.physics.add.image(130, 0, "bit1").setOrigin(0, 0);

          this.target.setMaxVelocity(0, speedDown);
          this.physics.add.overlap(
            this.target,
            this.player,
            this.getHit,
            null,
            this
          );
          if (window.innerWidth < 600 || orientation === "landscape") {
            this.cursors = this.input.addPointer();
          } else {
            this.cursors = this.input.keyboard.createCursorKeys();
          }
          // this.cursors = this.input.keyboard.createCursorKeys();

          this.textScore = this.add.text(sizes.width - 80, 16, "Score: 0", {
            fontSize: "18px Arial",
            fill: "#000",
          });
          this.textTime = this.add.text(16, 16, "Remaining Time: 00", {
            fontSize: "18px Arial",
            fill: "#000",
          });
          this.timedEvent = this.time.delayedCall(
            60000,
            this.gameOver,
            [],
            this
          );

          this.emitter = this.add.particles(0, 0, "moneyd", {
            speed: 80,
            gravityY: speedDown - 200,
            scale: 0.05,
            duration: 100,
            emitting: false,
          });
          this.emitter.startFollow(
            this.player,
            this.player.width / 10,
            this.player.height / 20,
            true
          );

          this.bomb = this.physics.add.image(sizes.width - 110, 0, "bomb");
          this.bomb.setMaxVelocity(0, speedDown);

          this.physics.add.overlap(
            this.player,
            this.bomb,
            this.hitBomb,
            null,
            this
          );
        }

        update() {
          this.remainingTime = this.timedEvent.getRemainingSeconds();
          this.textTime.setText(
            `Remaining Time: ${Math.round(this.remainingTime).toString()}`
          );
          if (this.target.y >= sizes.height) {
            this.target.setY(0);
            this.target.setX(this.getRandomX(400));
          }
          if (this.bomb.y >= sizes.height) {
            this.bomb.setY(0);
            this.bomb.setX(this.getRandomX(600));
          }
          this.hitBombOccurred = false;
          let isTouchingPlayer = false;

          isTouchingPlayer = (pointer) => {
            return (
              pointer.x >= this.player.x &&
              pointer.x <= this.player.x + this.player.width &&
              pointer.y >= this.player.y &&
              pointer.y <= this.player.y + this.player.height
            );
          };

          if (mediaQuery.matches || orientation === "landscape") {
            let isPlayerTouched = false;
            this.input.on(
              "pointerdown",
              (pointer) => {
                if (isTouchingPlayer(pointer)) {
                  isPlayerTouched = true;
                }
              },
              this
            );

            this.input.on(
              "pointermove",
              (pointer) => {
                if (isPlayerTouched) {
                  const velocityX = pointer.x - this.player.x + 100; // Визначаємо різницю між позицією вказівника та позицією гравця
                  this.player.setVelocityX(velocityX);
                }
              },
              this
            );

            this.input.on(
              "pointerup",
              () => {
                isPlayerTouched = false;
                this.player.setVelocityX(0); // При зупинці руху вказівника скидаємо швидкість гравця
              },
              this
            );
          } else {
            if (this.cursors.left.isDown) {
              this.player.setVelocityX(-this.playerSpeed);
            } else if (this.cursors.right.isDown) {
              this.player.setVelocityX(this.playerSpeed);
            } else {
              this.player.setVelocityX(0);
            }
          }
        }
        getRandomX(x) {
          return Math.floor(Math.random() * x);
        }

        getHit() {
          this.coinMusic.play();
          this.target.setY(0);
          this.target.setX(this.getRandomX(400));
          this.points++;
          this.textScore.setText(`Score:${this.points}`);
          this.emitter.start();
        }
        hitBomb() {
          this.bombMusic.play();
          this.target.setY(0);
          this.target.setX(this.getRandomX(600));
          this.points = 0;
          this.textScore.setText(`Score:${this.points}`);
        }

        gameOver() {
          this.sys.game.destroy(true);
          if (this.points >= 30) {
            refs.gameEndScoreSpan.textContent = this.points;
            refs.gameWinLoseSpan.textContent = "Victory🥳!";
            refs.gameSpam.textContent = "Please help Ukraine win! Donate👇";
            refs.gameResult.classList.add("resultWin");
          } else {
            refs.gameEndScoreSpan.textContent = this.points;
            refs.gameWinLoseSpan.textContent = "Lost!🙄";
            refs.gameSpam.textContent = "Don't forget to donate👇";
            refs.gameResult.classList.add("result");
          }
          refs.gameEndDiv.style.display = "flex";
          refs.link.style.display = "block";
        }
        startMusic() {
          if (!this.musicStarted) {
            this.bgMusic.play();
            this.musicStarted = true;
          }
        }
      }

      const config = {
        type: Phaser.WEBGL,
        width: sizes.width,
        height: sizes.height,
        canvas: gameCanvas,
        physics: {
          default: "arcade",
          arcade: {
            gravity: { y: speedDown },
            debug: true,
          },
        },
        scene: [GameScene],
      };
      const game = new Phaser.Game(config);

      //game.bgMusic.stop();

      refs.gameStartBtn.addEventListener("click", onStartClick);
      refs.gameStartBtn.addEventListener("touchstart", onStartClick, {
        passive: true,
      });
      function onStartClick() {
        refs.gameStartDiv.style.display = "none";
        game.scene.resume("scene-game");
        game.scene.getScene("scene-game").startMusic();
      }

      refs.gameRestartBtn.addEventListener("click", () => {
        refs.gameEndDiv.style.display = "none";
        location.reload();
      });
    </script>
  </body>
</html>
